<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[雨辰不语]]></title>
  <link href="http://suzhen.github.com/atom.xml" rel="self"/>
  <link href="http://suzhen.github.com/"/>
  <updated>2014-03-06T15:58:45+08:00</updated>
  <id>http://suzhen.github.com/</id>
  <author>
    <name><![CDATA[suzhen]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Javascript高阶之arguments]]></title>
    <link href="http://suzhen.github.com/blog/2014/03/06/javascriptgao-jie-zhi-arguments/"/>
    <updated>2014-03-06T15:53:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/03/06/javascriptgao-jie-zhi-arguments</id>
    <content type="html"><![CDATA[<p>arguments对象是所有function中可用的局部变量，它像是一个array,但并不是一个array（这一点下面会详细说明）。</p>

<p>在一个function内部，可以通过使用arguments对象来访问当前function的参数。这个类似于数组的对象包含了每个传入function的参数。index也是从0开始的。如果一个function被传入了三个参数，可以这么访问它们：</p>

<p>arguments[0]
arguments[1]
arguments[2]</p>

<p>当然这些参数也能被生置：</p>

<p>arguments[1] = &#8220;new value&#8221;</p>

<p>现在说说这个类似于array，但又不是array的arguments对象。它除了能像array一样通过index访问，还有一个length的属性，再没有像array的那些方法和属性了,比如pop方法或者push方法了。</p>

<p>但是我们又常常需要arguments对象具有array的这些方法，怎么办？其实它能被转化成一个真的array.</p>

<p>var args = Array.prototype.slice.call(arguments);</p>

<p>//问题：为什么是Array.prototype.slice，而不是Array.slice？
//回复：一个是实例方法，一个是类方法。</p>

<p>这样arguments就全部转化为了args数组，就可以对这个array实例用各种实例方法。</p>

<p>比如：我们传入的参数，前面n个是参数，而最后一个是callback函数。</p>

<p>如果获取这最后一个function的参数呢？</p>

<p>fn_callback = args.pop()</p>

<p>这样就可以获取到callback函数。</p>

<p>另外一种方法：</p>

<p>  var args = []</p>

<p>  args = Array.apply(args,arguments)</p>

<p> Array是一个类，那么Array也就是一个类的构造函数。</p>

<p>在call中，arguments是做为this，而在apply中，arguments是做为参数。关于apply和call在以后会有详细说明。</p>

<p>如果我们需要调用一个function时，并不确定要传入多少参数。那么在定义这个function的时候，就没必要再写任何形参了。</p>

<p>function f1(){</p>

<p>}</p>

<p>f1(&#8220;cat&#8221;,&#8221;dog&#8221;,&#8221;cow&#8221;,&#8221;snake&#8221;)</p>

<p>或者我们只需要一个参数，但传入了多个参数。</p>

<p>function f1(animal){</p>

<p>}
f1(&#8220;cat&#8221;,&#8221;dog&#8221;,&#8221;cow&#8221;,&#8221;snake&#8221;)</p>

<p>这时候，用arguments对象就非常有用了。</p>

<p>可以用arguments.length来判断传入参数的个数。也可以用arguments处理每个参数。</p>

<p>有一个小技巧可以利用：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">myConcat</span><span class="p">(</span><span class="nx">separator</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">separator</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">You</span> <span class="nx">can</span> <span class="nx">pass</span> <span class="nx">any</span> <span class="nx">number</span> <span class="nx">of</span> <span class="nx">arguments</span> <span class="nx">to</span> <span class="k">this</span> <span class="kd">function</span><span class="p">,</span> <span class="nx">and</span> <span class="nx">it</span> <span class="nx">creates</span> <span class="nx">a</span> <span class="nx">list</span> <span class="nx">using</span> <span class="nx">each</span> <span class="nx">argument</span> <span class="nx">as</span> <span class="nx">an</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">list</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// returns &quot;red, orange, blue&quot;</span>
</span><span class='line'><span class="nx">myConcat</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// returns &quot;elephant; giraffe; lion; cheetah&quot;</span>
</span><span class='line'><span class="nx">myConcat</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">,</span> <span class="s2">&quot;elephant&quot;</span><span class="p">,</span> <span class="s2">&quot;giraffe&quot;</span><span class="p">,</span> <span class="s2">&quot;lion&quot;</span><span class="p">,</span> <span class="s2">&quot;cheetah&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// returns &quot;sage. basil. oregano. pepper. parsley&quot;</span>
</span><span class='line'><span class="nx">myConcat</span><span class="p">(</span><span class="s2">&quot;. &quot;</span><span class="p">,</span> <span class="s2">&quot;sage&quot;</span><span class="p">,</span> <span class="s2">&quot;basil&quot;</span><span class="p">,</span> <span class="s2">&quot;oregano&quot;</span><span class="p">,</span> <span class="s2">&quot;pepper&quot;</span><span class="p">,</span> <span class="s2">&quot;parsley&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>myConcat只有一个参数，这个参数是用来传入连接之后每一个参数的字符的。这种参数就需要特定的形参来固定下来，如果只是枚举的参数，就不需要形参，在调用的时候，直接转入去就可以了。通过arguments对象可以获取到。</p>

<p>arguments对象除了length属性，还有一个callee属性</p>

<p>arguments.callee 获取当前执行的function，递归的时候会有用。但会有一个疑问，用方法名不就可以吗? 但是有匿名方法的时候，这个有用了。而且，如果function内部重复用方法名，要是想改方法名就需要改多个地方。容易出错。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">create</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>         <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span><span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">create</span><span class="p">()(</span><span class="mi">5</span><span class="p">);</span> <span class="c1">// returns 120 (5 * 4 * 3 * 2 * 1)</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ActiveModel与ActiveRecrod的选择]]></title>
    <link href="http://suzhen.github.com/blog/2014/03/06/activemodelyu-activerecrodde-xuan-ze/"/>
    <updated>2014-03-06T15:41:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/03/06/activemodelyu-activerecrodde-xuan-ze</id>
    <content type="html"><![CDATA[<p>如果我们有一个类，继承了ActiveRecord::Base，那么意味着这是一个用来做model的类。它具有了把数据存入数据库的能力。除此之外还拥有了关于验证（Validations）的类方法，关于转化（Conversion）的实例方法，关于命名（Naming）的类方法等等。
  但其实，除了把数据存入数据库的能力，是ActiveRcord提供的。其它的功能都是ActiveModel完成的。只是ActiveRecord有了对ActiveModel的依赖。
  换句话说，如果我们不准备把数据存入库，但还是希望这个类，像个model一样的工作。那么直接混入ActiveModel就可以了。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span><span class="ss">:age</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Model</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  那么Person的对象不再有save,update,Person类也不再有all,find,where等与数据保存，修改，查询，删除等一切方法。
  但具有了以下方法：</p>

<ol>
<li>to_model, to_key, to_param, persisted?</li>
<li>model_name 以及 model_name.human, model_name.partial_path, model_name.singular, model_name.plural</li>
<li>valid?, errors 以及 errors[], errors.full_messages</li>
</ol>


<p>  但Person依然能像一般model类一样，实例化一个对象。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="o">=&gt;</span> <span class="s2">&quot;suzhen&quot;</span><span class="p">,</span> <span class="ss">:age</span><span class="o">=&gt;</span><span class="mi">18</span><span class="p">)</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>  但遗憾的是这种用法只能在rails4.0及以上使用。rails3的版本只能分别引入ActiveModel的各module.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span><span class="ss">:age</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span> <span class="c1">#混入验证功能</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Conversion</span> <span class="err">＃混入转化功能</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">extend</span>  <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Naming</span> <span class="err">＃混入命名功能</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">…</span> <span class="err">…</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="o">=&gt;</span> <span class="s2">&quot;suzhen&quot;</span><span class="p">,</span> <span class="ss">:age</span><span class="o">=&gt;</span><span class="mi">18</span><span class="p">)</span> <span class="err">＃这样会报错</span> <span class="no">ArgumentError</span><span class="p">:</span> <span class="n">wrong</span> <span class="n">number</span> <span class="n">of</span> <span class="n">arguments</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="mi">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>  如果想像model那样的可以把参数传入就需要，重写initialize即可：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="c1">#元编程再次发威</span>
</span><span class='line'>    <span class="n">attributes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  完整code如下：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Person</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span><span class="ss">:age</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Validations</span> <span class="c1">#混入验证功能</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Conversion</span> <span class="c1">#混入转化功能</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">extend</span>  <span class="no">ActiveModel</span><span class="o">::</span><span class="no">Naming</span> <span class="c1">#混入命名功能</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>          <span class="n">attributes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
</span><span class='line'>              <span class="nb">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="o">=</span> <span class="no">Person</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="o">=&gt;</span> <span class="s2">&quot;suzhen&quot;</span><span class="p">,</span> <span class="ss">:age</span><span class="o">=&gt;</span><span class="mi">18</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">18</span>
</span><span class='line'>  <span class="nb">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;suzhen&quot;</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RUBY魔法师（方法高级篇）]]></title>
    <link href="http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-%28fang-fa-gao-ji-pian-%29/"/>
    <updated>2014-02-23T11:37:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-(fang-fa-gao-ji-pian-)</id>
    <content type="html"><![CDATA[<p>  一、动态创建method和动态调用方法</p>

<p>  问题：什么是动态创建和动态调用方法？
  答：就是代码在运行过程时，才定义的方法。同样，只有在代码运行时，才能开始调用的方法，是动态调用方法，这是一组很有用的魔法。</p>

<p>  魔法师用define_method来动态创建实例方法：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>    <span class="c1">#动态创建一个实例方法say_hi</span>
</span><span class='line'>    <span class="n">define_method</span> <span class="ss">:say_hi</span> <span class="k">do</span> <span class="o">|</span> <span class="nb">name</span> <span class="o">|</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;HI,</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="c1">#动态创建一个类方法say_hello</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>      <span class="n">define_method</span> <span class="ss">:say_hello</span> <span class="k">do</span> <span class="o">|</span> <span class="nb">name</span> <span class="o">|</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;Hello,</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">say_hi</span><span class="p">(</span><span class="s2">&quot;suzhen&quot;</span><span class="p">)</span> <span class="c1">#-&gt;  HI,suzhen</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;suzhen&quot;</span><span class="p">)</span> <span class="c1">#-&gt; Hello,suzhen</span>
</span></code></pre></td></tr></table></div></figure>


<p>  创建单例方法：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="n">obj</span> <span class="o">=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">obj2</span> <span class="o">=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span>
</span><span class='line'>        <span class="n">define_method</span> <span class="ss">:say_hi</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;HI&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">obj</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#-&gt;HI</span>
</span><span class='line'>   <span class="n">obj</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#-&gt; mt_ad.rb:30:in `&lt;main&gt;&#39;: undefined method `say_hi&#39; for #&lt;Dummy:0x007fce6c109068&gt; (NoMethodError)</span>
</span></code></pre></td></tr></table></div></figure>


<p>  说明：</p>

<p>  1、define_method是一个private方法</p>

<p>  2、由于define_method是一个private方法，它不能被显式调用。</p>

<p>  3、define_method是Module类的一个instance_method,只能由一个具体的module和一个具体的class来调用。</p>

<pre><code>因为:
</code></pre>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">DummyModule</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">DummyModule</span><span class="o">.</span><span class="n">class</span> <span class="c1">#—&gt;Module</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">class</span> <span class="c1">#—&gt;Class</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">superclass</span> <span class="c1">#—&gt;Module</span>
</span></code></pre></td></tr></table></div></figure>


<p>  一个具体的module或者一个具体的class都是Module类的实例。</p>

<p>  4、为当前self(必须是类，不管是普通类还是eigenclass)创建一个instance method,换句话说就是define_method消息的接收者只能是类对象。</p>

<p>  比如：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1">#当前self是Dummy类本身，所以此处定义的是Dummy的实例方法。</span>
</span><span class='line'>    <span class="n">define_method</span> <span class="ss">:say_hello</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;hello,suzhen&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_method</span>
</span><span class='line'>      <span class="c1">#类方法中的self，代表的也是Dummy类本身，所以此处定义的是Dummy的实例方法。</span>
</span><span class='line'>      <span class="n">define_method</span> <span class="ss">:say_hi</span> <span class="k">do</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">say_hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">create_method</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">say_hi</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">————————————————————</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="no">Dummy</span>
</span><span class='line'>    <span class="c1">#此处的self是Dummy的eigenclass，所以就是创建eigenclass类的实例方法，也就是Dummy的类方法。</span>
</span><span class='line'>    <span class="n">define_method</span> <span class="ss">:say_bye</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;bye&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_bye</span>
</span></code></pre></td></tr></table></div></figure>


<p>  或者：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_class_method</span>
</span><span class='line'>      <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>         <span class="n">define_method</span> <span class="ss">:say_love</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;love&quot;</span>
</span><span class='line'>         <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">create_class_method</span>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_love</span> <span class="c1">#—&gt; love</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">————————————————————</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">define_new_method_by_other_method</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">#注意这里的self代表的是Dummy的实例对象。并不是类对象，所以是没有define_method方法的。</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">define_method</span> <span class="ss">:say_hi</span> <span class="k">do</span> <span class="o">|</span> <span class="nb">name</span> <span class="o">|</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;HI,</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">define_new_method_by_other_method</span> <span class="c1">#报错</span>
</span></code></pre></td></tr></table></div></figure>


<p>  综上所述可以看出，我们在使用define_method方法都是在当前类的内部。而作为private方法是不可以在外面调用的，比如：</p>

<p>  Dummy.define_method :say_hi do end # 访问保护</p>

<p>  或者</p>

<p>  obj = Dummy.new</p>

<p>  obj.class.define_method :say_hi do end＃访问保护</p>

<p>  但魔法师当然有他的魔术：send</p>

<p>  send 不仅可以动态调用方法，还可以调用私有方法。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="nb">proc</span> <span class="o">=</span> <span class="nb">lambda</span><span class="p">{</span> <span class="nb">puts</span> <span class="s2">&quot;suzhen&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span><span class="ss">:say_hi</span><span class="p">,</span><span class="o">&amp;</span><span class="nb">proc</span>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">say_hi</span>
</span></code></pre></td></tr></table></div></figure>


<p>  或者</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span><span class="ss">:say_hi</span><span class="p">,</span><span class="o">&amp;</span><span class="nb">proc</span>
</span></code></pre></td></tr></table></div></figure>


<p>  给obj的eigenclass动态定义方法</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">send</span>  <span class="ss">:define_method</span><span class="p">,</span><span class="ss">:say_hi</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span>  <span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#suzhen</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj2</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#报错</span>
</span></code></pre></td></tr></table></div></figure>


<p>  在类的外部动态创建类的类方法</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">send</span>  <span class="ss">:define_method</span><span class="p">,</span><span class="ss">:say_hi</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span>  <span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#—&gt; suzhen</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>  我们发现从外面给一个实例对象动态创建方法，或者给一个类动态创建方法，都需要先获取他们的eigenclass，再通过send 动态调用define_method方法，把要动态创建的方法名和block做为参数再传入。</p>

<p>  这样太麻烦了。有没有简单点的方法呢？魔法师给了我们一个魔法：define_singleton_method 它是Object类的一个实例方法。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="n">obj</span> <span class="o">=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">obj2</span> <span class="o">=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">define_singleton_method</span> <span class="ss">:say_hi</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#-&gt; suzhen</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj2</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#-&gt;报错</span>
</span></code></pre></td></tr></table></div></figure>


<p>  或者</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">define_singleton_method</span> <span class="ss">:say_hello</span> <span class="k">do</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;hello&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">define_singleton_method</span> <span class="err">为我们的工作减少不小的工作量：</span>
</span></code></pre></td></tr></table></div></figure>


<p>  1，减少获取eigenclass的过程： (class &lt;&lt; obj ;self; end) ｜ (class &lt;&lt; Dummy ;self; end) 或者obj.singeton_class | Dummy.singenton_class</p>

<p>  2，减少了eigenclass使用send动态调用define_method的过程:   (eigenClass).send :define_method,agru,&amp;block</p>

<p>  下一个要考虑的问题就是：</p>

<p>  设置动态创建的method的权限。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="kp">private</span>  <span class="ss">:say_hi</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="err">或者：</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">send</span> <span class="ss">:private</span><span class="p">,</span><span class="ss">:say_hi</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">say_hi</span> <span class="err">＃报错</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="kp">private</span> <span class="ss">:say_hello</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hello</span> <span class="c1">#报错</span>
</span></code></pre></td></tr></table></div></figure>


<p>  我们来复习一下上面的内容发现：defind_methd 可以在一个普通类里动态定义方法，也可以在eigenClass里动态定义方法。可以在一个类内部动态定义方法，也可以在一个类外部通过send进行动态方法的定义。</p>

<p>  以上说的是method的动态定义，动态执行。  那么根据增删查改的模式，我还要了解 “删”，“查”，“改”（重载或者）</p>

<p>  那么如何删除一个方法？</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="n">undef_method</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">remove_method</span>  <span class="err">相应的</span><span class="n">callback</span> <span class="n">method_removed</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">hello</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;In parent&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Child</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">hello</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;In child&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">c</span> <span class="o">=</span> <span class="no">Child</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="n">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Child</span>
</span><span class='line'>     <span class="n">remove_method</span> <span class="ss">:hello</span>  <span class="c1"># remove from child, still in parent</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="n">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Child</span>
</span><span class='line'>      <span class="n">undef_method</span> <span class="ss">:hello</span>   <span class="c1"># prevent any calls to &#39;hello&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="n">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">In</span> <span class="n">child</span>
</span><span class='line'>  <span class="no">In</span> <span class="n">parent</span>
</span><span class='line'>  <span class="n">prog</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span> <span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`hello&#39; for #&lt;Child:0x401b3bb4&gt; (NoMethodError)</span>
</span></code></pre></td></tr></table></div></figure>


<p>  undef_method与remove_method的用法与define_method是一样的。区别在于，remove_method 只是移除了本类中的方法，但父类的方法还在。对象还是可以调用该方法的。但undef_method就彻底把方法从家族中移除了。</p>

<p>  如何查看有哪些方法呢？</p>

<p>  methods;
  instance_methods;
  private_instance_methods;protected_instance_methods;public_instance_methods;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby之类对象]]></title>
    <link href="http://suzhen.github.com/blog/2014/02/23/rubyzhi-lei-dui-xiang/"/>
    <updated>2014-02-23T11:26:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/02/23/rubyzhi-lei-dui-xiang</id>
    <content type="html"><![CDATA[<p>先熟悉一下类对象。</p>

<p>  它有点像是作用在整个类继承层次的 全局变量, 它的行为像是没有命名空间的全局常量, 在 一个类及其所有子类中 总是唯一的. 既然他属于 类和它的子孙 公用的那一部分, 那也必然应该属于类了, @@类变量是私有的, 只能在类定义内部隐式的访问它.</p>

<p>  @@对象不仅被类族中类方法访问，也可以被类族中的实例对象访问到。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>    <span class="vc">@@name</span> <span class="o">=</span> <span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">name</span>
</span><span class='line'>      <span class="vc">@@name</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">name</span>
</span><span class='line'>      <span class="vc">@@name</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">name</span>    <span class="c1"># suzhen</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">name</span>  <span class="c1">#suzhen</span>
</span></code></pre></td></tr></table></div></figure>


<p>  active_support中对这种类对象有很好的封装。看下面代码：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="nb">require</span> <span class="s2">&quot;active_support/all&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>    <span class="n">mattr_accessor</span> <span class="ss">:name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">name</span> <span class="c1">#suzhen</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">name</span>  <span class="c1">#suzhen</span>
</span></code></pre></td></tr></table></div></figure>


<p>  mattr_accessor 就是帮我们创建了一组类方法和一组实例方法</p>

<p>  有的时候，我们只想给出类方法的访问，而不想给出实例方法的访问。</p>

<p>  mattr_accessor :name,:instance_accessor=>false</p>

<p>  至于mattr_accessor 是如何实现的，可以看rails的代码。</p>

<p>  https://github.com/rails/rails/blob/master/activesupport/lib/active_support/core_ext/module/attribute_accessors.rb</p>

<p>  mattr_accessor 与 cattr_accessor 是一样的。</p>

<p>  我们看下面的例子：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">SomeModule</span>
</span><span class='line'>    <span class="vc">@@logger</span> <span class="o">=</span> <span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">SomeModule</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">say</span>
</span><span class='line'>      <span class="vc">@@logger</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>      <span class="vc">@@logger</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">say</span>   <span class="err">＃</span><span class="n">suzhen</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">say</span> <span class="c1">#suzhen</span>
</span></code></pre></td></tr></table></div></figure>


<p>  当一个class引入一个module就是这个class就继承了这个module,那么module中定义的类变量，就可以在这上类家庭中使用了。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">SomeModule</span>
</span><span class='line'>    <span class="n">mattr_accessor</span> <span class="ss">:logger</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="no">SomeModule</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">logger</span>  <span class="err">＃</span><span class="n">suzhen</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">logger</span>  <span class="c1">#error</span>
</span></code></pre></td></tr></table></div></figure>


<p>  但是上面这个例子中，mattr_accessor 把类方法 self.logger 和self.logger=定义在了module中，include自然不会引用这种类方法。但实例方法是可以用的。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">SomeMoudle</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>      <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">mattr_accessor</span> <span class="ss">:logger</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="s2">&quot;suzhen&quot;</span>   <span class="c1">#初始化的时候一定把self加上。显示的调用。</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  用以上这种方法自然可以解决这个问题。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby魔法师(访问控制)]]></title>
    <link href="http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-fang-wen-kong-zhi/"/>
    <updated>2014-02-23T11:20:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-fang-wen-kong-zhi</id>
    <content type="html"><![CDATA[<p>一个class中的method有三种访问权限，public , protected, private</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Car</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pub_method</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Car running&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pro_method</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Car booting&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pri_method</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;engine start&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span><span class="o">.</span><span class="n">pub_method</span> <span class="c1">#输出 Car running</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span><span class="o">.</span><span class="n">pro_method</span> <span class="c1">#报错 protected method不可以被调用</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span><span class="o">.</span><span class="n">pri_method</span> <span class="c1"># 报错 private method不可以调用</span>
</span></code></pre></td></tr></table></div></figure>


<p>  从以上例子可以看出 class 里的instance_method默认是public的,object的protected和private的method是不可以在外部直接调用的。只能在instance_method内部调用。</p>

<p>  这里特别要注意的是：</p>

<p>  在method调用 里有 显示调用 和 隐藏调用 两种方式，例如:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Car</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pub_method</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">#self隐藏调用</span>
</span><span class='line'>      <span class="n">pro_method</span>
</span><span class='line'>      <span class="n">pri_method</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Car running&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pro_method</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Car booting&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pri_method</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;engine start&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span><span class="o">.</span><span class="n">pub_method</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#输出 engine start</span>
</span><span class='line'>      <span class="no">Car</span> <span class="n">booting</span>
</span><span class='line'>      <span class="no">Car</span> <span class="n">running</span>
</span></code></pre></td></tr></table></div></figure>


<p>  !!! *** pro_method和pri_method都支持隐藏调，但是只有protected支持显示调用，private不支持显示调用。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Car</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pub_method</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">#self显示调用</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">pro_method</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">pri_method</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Car running&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pro_method</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Car booting&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pri_method</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;engine start&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">car</span><span class="o">.</span><span class="n">pub_method</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">pri_method</span> <span class="c1">#是会报错的，而self.pro_method是可以通过的。</span>
</span></code></pre></td></tr></table></div></figure>


<p>  显示或者隐藏调用的对象不仅仅是指self，还有同类别的对象（包括同类的对象和子类的对象）。</p>

<p>  例子如下：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">C</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>         <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>      <span class="c1">#c是同类别的对象 （神奇的魔法）</span>
</span><span class='line'>          <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="vi">@name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">protected</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">name</span>
</span><span class='line'>          <span class="vi">@name</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">D</span> <span class="o">&lt;</span> <span class="n">C</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">d1</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;fankai&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">d2</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">d1</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>  这个例子，即保证不能让客户端读取到对象的名称，又能在类内部可以获取到实例变量。</p>

<p>  接着我们可以看一个ruby类的继承关系。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">A</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pub_method</span>
</span><span class='line'>      <span class="n">method1</span>
</span><span class='line'>      <span class="n">method2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">method1</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;hello&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">protected</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">method2</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;world&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">B</span> <span class="o">&lt;</span> <span class="n">A</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pub_method2</span>
</span><span class='line'>      <span class="n">method1</span>
</span><span class='line'>      <span class="n">method2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">C</span> <span class="o">&lt;</span> <span class="n">B</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">pub_method3</span>
</span><span class='line'>      <span class="n">method1</span>
</span><span class='line'>      <span class="n">method2</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">A</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">pub_method</span> <span class="c1"># 输出 hello world</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">B</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">pub_method2</span> <span class="c1"># 输出 hello world</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">pub_method3</span> <span class="c1"># 输出 hello world</span>
</span></code></pre></td></tr></table></div></figure>


<p>  由些可见，ruby在继承关系中public 和 protected 和 private都是一样，全部可以被继承。</p>

<p>  通过我们会认为类的方法是没有private和protected之分的，我们来看以下的例子：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>      <span class="kp">private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">say_hi</span>
</span><span class='line'>         <span class="nb">puts</span> <span class="s2">&quot;hi&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hi</span>  <span class="c1">#-&gt; hi    说明private对类方法是没有的。</span>
</span></code></pre></td></tr></table></div></figure>


<p>  但是魔法师没有什么是做不到的，如果你想要，类方法有可以有这种调用限制。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>          <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>              <span class="kp">protected</span>
</span><span class='line'>              <span class="k">def</span> <span class="nf">say_hello</span>
</span><span class='line'>                <span class="nb">puts</span> <span class="s2">&quot;hello&quot;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hello</span> <span class="c1">#in `&lt;main&gt;&#39;: protected method `say_hello&#39; called for Dummy:Class (NoMethodError)</span>
</span></code></pre></td></tr></table></div></figure>


<p>  看了上面的例子你来会认为类的方法是没有private和protected之分的吗？？？</p>

<p>  我想说ruby,你他妈的太牛逼了！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RUBY魔法师(初始化对象)]]></title>
    <link href="http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-chu-shi-hua-dui-xiang/"/>
    <updated>2014-02-23T11:00:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-chu-shi-hua-dui-xiang</id>
    <content type="html"><![CDATA[<p>  我们会创建一个class。通过这个class去new出一个又一个对象。这个类里有许多的对象实例变量，有的是需要new的时候去设置的。有的对象实例变量有一些默认值。我们该怎么去设计一个好的类呢。</p>

<p>  最普通的设计方法：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Volume</span>
</span><span class='line'>      <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:type</span><span class="p">,</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:date_created</span><span class="p">,</span> <span class="ss">:date_modified</span><span class="p">,</span> <span class="ss">:iscsi_target</span><span class="p">,</span> <span class="ss">:iscsi_portal</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">SYSTEM</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="no">DATA</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>        <span class="vi">@name</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@size</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@type</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:type</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="no">SYSTEM</span> <span class="p">:</span>  <span class="n">args</span><span class="o">[</span><span class="ss">:type</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@owner</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:owner</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@iscsi_target</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:iscsi_target</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@iscsi_portal</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="ss">:iscsi_portal</span><span class="o">]</span>
</span><span class='line'>        <span class="vi">@date_created</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@date_modified</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="vi">@name</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="vi">@size</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="vi">@type</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@owner</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:date_created</span> <span class="o">=&gt;</span> <span class="vi">@date_created</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:date_modified</span> <span class="o">=&gt;</span> <span class="vi">@date_modified</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:iscsi_target</span> <span class="o">=&gt;</span> <span class="vi">@iscsi_target</span><span class="p">,</span>
</span><span class='line'>                <span class="ss">:iscsi_portal</span> <span class="o">=&gt;</span> <span class="vi">@iscsi_portal</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">to_json</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">inspect</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  要求：init的时候，可以传入配置项，也可以什么都不传。但无论传不传argument都要保证有@type的实例变量是有值的。</p>

<p>  我们要对这个类进行重构。</p>

<p>  用rspec 去保证重构的正确性。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">require</span> <span class="s2">&quot;./init&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;Object Init&quot;</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;all arguments are existing&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</span><span class='line'>        <span class="vi">@v</span> <span class="o">=</span> <span class="no">Volume</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="ss">:name</span><span class="o">=&gt;</span><span class="s1">&#39;suzhen&#39;</span><span class="p">,</span><span class="ss">:size</span><span class="o">=&gt;</span><span class="s2">&quot;300&quot;</span><span class="p">,</span><span class="ss">:owner</span><span class="o">=&gt;</span><span class="s2">&quot;sue&quot;</span><span class="p">,</span><span class="ss">:iscsi_target</span><span class="o">=&gt;</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="ss">:iscsi_portal</span><span class="o">=&gt;</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="ss">:type</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object name should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;suzhen&quot;</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object size should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;300&quot;</span> <span class="k">end</span>
</span><span class='line'>          <span class="n">it</span> <span class="s2">&quot;Volume object owner should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="s2">&quot;sue&quot;</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object iscsi_portal should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">iscsi_portal</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object iscsi_target should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">iscsi_target</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object date_created should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">date_created</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object date_modified should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">date_modified</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object type should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;to json should &quot;</span> <span class="k">do</span>
</span><span class='line'>       <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="vi">@v</span><span class="o">.</span><span class="n">to_json</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;suzhen&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;300&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;sue&quot;</span><span class="p">,</span> <span class="s2">&quot;date_created&quot;</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="s2">&quot;date_modified&quot;</span><span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="s2">&quot;iscsi_target&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;iscsi_portal&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;&quot;</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;none arguments&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</span><span class='line'>        <span class="vi">@v</span> <span class="o">=</span> <span class="no">Volume</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object name should nil&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">nil</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object size should nil&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">nil</span> <span class="k">end</span>
</span><span class='line'>          <span class="n">it</span> <span class="s2">&quot;Volume object owner should nil&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="kp">nil</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object iscsi_portal should nil&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">iscsi_portal</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">nil</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object iscsi_target should nil&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">iscsi_target</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">nil</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object date_created should nil&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">date_created</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object date_modified should nil&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">date_modified</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;Volume object type should has value&quot;</span> <span class="k">do</span> <span class="vi">@v</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">end</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;to_json should &quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="vi">@v</span><span class="o">.</span><span class="n">to_json</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;owner&quot;</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;date_created&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;2013-02-02 00:00:00 +0800&quot;</span><span class="p">,</span> <span class="s2">&quot;date_modified&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;2013-02-02 00:00:00 +0800&quot;</span><span class="p">,</span> <span class="s2">&quot;iscsi_target&quot;</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">,</span> <span class="s2">&quot;iscsi_portal&quot;</span><span class="o">=&gt;</span><span class="kp">nil</span><span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  1，看到一长串的实例变量名称，会把这些名称放进一个array里，并且把这个array冻结起来，不能随意增加或者减少了。然后再遍历这个array,生成读写方法。</p>

<p>  注释掉这句 # attr_accessor :name, :size, :type, :owner, :date_created, :date_modified, :iscsi_target, :iscsi_portal</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="no">ATTRIBUTES</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="ss">:name</span><span class="p">,</span> <span class="ss">:size</span><span class="p">,</span> <span class="ss">:type</span><span class="p">,</span> <span class="ss">:owner</span><span class="p">,</span> <span class="ss">:date_created</span><span class="p">,</span> <span class="ss">:date_modified</span><span class="p">,</span><span class="ss">:iscsi_target</span><span class="p">,</span><span class="ss">:iscsi_portal</span>
</span><span class='line'>    <span class="o">].</span><span class="n">freeze</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">ATTRIBUTES</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span>
</span><span class='line'>      <span class="kp">attr_accessor</span> <span class="kp">attr</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<pre><code>test通过。
</code></pre>

<p>   还可以再简单一点</p>

<p>  注释掉
  ＃ ATTRIBUTES.each do |attr|</p>

<pre><code>＃  attr_accessor attr
</code></pre>

<p>   ＃ end</p>

<p>  改为：</p>

<p>   attr_accessor *ATTRIBUTES</p>

<p>   test通过。</p>

<p>  2 修改initialize方法，因为有了之前的ATTRIBUTES数组，这里就可以不用一个个写方法赋值了。</p>

<p>  注释掉原来的initialize方法</p>

<p>  ＃def initialize(args={})</p>

<pre><code>＃    @name = args[:name]
</code></pre>

<p>   ＃     @size = args[:size]</p>

<pre><code>＃    @type = args[:type].nil? ? SYSTEM :  args[:type]
＃    @owner = args[:owner]
＃    @iscsi_target = args[:iscsi_target]
 ＃   @iscsi_portal = args[:iscsi_portal]
＃    @date_created = Time.new(2013,2,2)
 ＃   @date_modified = Time.new(2013,2,2)
</code></pre>

<p>   ＃ end</p>

<p>  改为：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="no">DEFAULTS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="no">SYSTEM</span>
</span><span class='line'>      <span class="p">}</span><span class="o">.</span><span class="n">freeze</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="p">?</span> <span class="no">DEFAULTS</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">:</span> <span class="no">DEFAULTS</span>
</span><span class='line'>        <span class="no">ATTRIBUTES</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="kp">attr</span><span class="p">))</span>
</span><span class='line'>            <span class="nb">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="kp">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">[</span><span class="kp">attr</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="vi">@date_created</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>           <span class="vi">@date_modified</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="nb">test</span><span class="err">通过。</span>
</span><span class='line'>
</span><span class='line'>        <span class="mi">3</span> <span class="err">修改</span><span class="nb">inspect</span><span class="err">方法</span>
</span><span class='line'>
</span><span class='line'>   <span class="err">＃</span><span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>     <span class="err">＃</span>   <span class="k">return</span> <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="vi">@name</span><span class="p">,</span>
</span><span class='line'>    <span class="err">＃</span>            <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="vi">@size</span><span class="p">,</span>
</span><span class='line'>      <span class="err">＃</span>          <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="vi">@type</span><span class="p">,</span>
</span><span class='line'>      <span class="err">＃</span>          <span class="ss">:owner</span> <span class="o">=&gt;</span> <span class="vi">@owner</span><span class="p">,</span>
</span><span class='line'>      <span class="err">＃</span>          <span class="ss">:date_created</span> <span class="o">=&gt;</span> <span class="vi">@date_created</span><span class="p">,</span>
</span><span class='line'>      <span class="err">＃</span>          <span class="ss">:date_modified</span> <span class="o">=&gt;</span> <span class="vi">@date_modified</span><span class="p">,</span>
</span><span class='line'>       <span class="err">＃</span>         <span class="ss">:iscsi_target</span> <span class="o">=&gt;</span> <span class="vi">@iscsi_target</span><span class="p">,</span>
</span><span class='line'>       <span class="err">＃</span>         <span class="ss">:iscsi_portal</span> <span class="o">=&gt;</span> <span class="vi">@iscsi_portal</span> <span class="p">}</span>
</span><span class='line'>     <span class="err">＃</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inspect</span>
</span><span class='line'>        <span class="no">ATTRIBUTES</span><span class="o">.</span><span class="n">inject</span><span class="p">({</span> <span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="kp">attr</span><span class="o">|</span>
</span><span class='line'>          <span class="n">h</span><span class="o">[</span><span class="kp">attr</span><span class="o">]</span> <span class="o">=</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="kp">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">h</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>   test通过。</p>

<p>  可以把inspect的效果写的更绚一点</p>

<p>  Hash[ *ATTRIBUTES.map { |attr| [ attr, instance_variable_get(&#8220;@#{attr}&#8221;) ] }.flatten ]</p>

<p>   test通过。</p>

<p>  4 如果我们觉得用initialize传入option这种方式太土，可以用一种更COOL的方式。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>       <span class="err">＃第一步先初始化默认值</span>
</span><span class='line'>        <span class="no">ATTRIBUTES</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="kp">attr</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">self</span><span class="o">.</span><span class="n">__send__</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="kp">attr</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="no">DEFAULTS</span><span class="o">[</span><span class="kp">attr</span><span class="o">]</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>          <span class="err">＃通过</span><span class="n">attr_access</span> <span class="err">定义的读写方法来赋值</span>
</span><span class='line'>        <span class="k">yield</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="k">if</span> <span class="nb">block_given?</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  那么初始化方式为：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="vi">@v</span> <span class="o">=</span> <span class="no">Volume</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;suzhen&quot;</span><span class="p">;</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;300&quot;</span><span class="p">;</span><span class="n">v</span><span class="o">.</span><span class="n">owner</span><span class="o">=</span><span class="s2">&quot;sue&quot;</span><span class="p">;</span><span class="n">v</span><span class="o">.</span><span class="n">iscsi_target</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="n">v</span><span class="o">.</span><span class="n">iscsi_portal</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="n">v</span><span class="o">.</span><span class="n">date_created</span><span class="o">=</span><span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="n">v</span><span class="o">.</span><span class="n">date_modified</span><span class="o">=</span><span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">2013</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RUBY继承initialize时的顺序]]></title>
    <link href="http://suzhen.github.com/blog/2014/02/23/rubyji-cheng-initializeshi-de-shun-xu/"/>
    <updated>2014-02-23T10:52:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/02/23/rubyji-cheng-initializeshi-de-shun-xu</id>
    <content type="html"><![CDATA[<p>RUBY继承initialize时的顺序</p>

<p>我们分析一下有几种继承情况：</p>

<p>1、一个子类继承一个父类。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">family_name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">family_name</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;parent&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Son</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;son&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  子类和父类都有initialize方法，子类的会覆盖父类的同名方法，父类的initalize方法不会被执行。</p>

<p>  Son.new #->  son</p>

<p>  如果子类打算调用父类的initalize方法，就必须使用super明显的调用:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Son</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">(</span><span class="s2">&quot;sue&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;son&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Son</span><span class="o">.</span><span class="n">new</span> <span class="c1">#-&gt;  sue parent son</span>
</span></code></pre></td></tr></table></div></figure>


<p>2、一个类include一个module。</p>

<p>  这种方式其实就是在让class继承一个“代理类”。这个“代理类”就是module生成的。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">module</span> <span class="nn">Skill</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;skill&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Son</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Skill</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;son&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  class和module都有initialize方法，class会覆盖module的同名方法，module的initalize方法不会被执行。</p>

<p>  Son.new #->  son</p>

<p>  如果class打算调用module的initalize方法，就必须使用super明显的调用:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Son</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Skill</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">()</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;son&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Son</span><span class="o">.</span><span class="n">new</span> <span class="c1">#-&gt;  skill son</span>
</span></code></pre></td></tr></table></div></figure>


<p>3、一个类include多个module.</p>

<p>  一个class能include多个module,这是Matz在解决类多继承的一个方式。我们要理解这种继承方式，class能继承多类，但是一层一层的继承，继承是有顺序的，是线性的，不是菱型的。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">module</span> <span class="nn">Skill</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;skill&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Interest</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;interest&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Son</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Skill</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Interest</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">()</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;son&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  Son类include两个module的顺序就非常的重要，这会影响到module的“代理类”在继承线上顺序的。这个例子中 可以认为是son类继承了interest代理类，interest代理类继承了skill代理类。   Son&lt;Interest&lt;Skill</p>

<p>  同理：同名方法会被覆盖。super的调用只会调用父类，如果要调用祖父类的同名方法，就要在父类的同名方法中使用super。super只针对父类的同名方法，不能跨级调用。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">module</span> <span class="nn">Skill</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;skill&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Interest</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">()</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;interest&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Son</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Skill</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Interest</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">()</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;son&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Son</span><span class="o">.</span><span class="n">new</span> <span class="c1">#-&gt;  skill interest son</span>
</span></code></pre></td></tr></table></div></figure>


<p>4、一个类即继承一个父类，又包含若干个module</p>

<p>  分析这个情况，要明白：“代理类”要比真正要继承的类，更先被继承。在继承线上更靠前。根据以上的学习我们会很快写出结果：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">module</span> <span class="nn">Skill</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">(</span><span class="s2">&quot;sue&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;skill&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Interest</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">()</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;interest&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Parent</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">family_name</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="n">family_name</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;parent&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Son</span> <span class="o">&lt;</span> <span class="no">Parent</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Skill</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Interest</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>      <span class="k">super</span><span class="p">()</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;son&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Son</span><span class="o">.</span><span class="n">new</span> <span class="c1">#-&gt; sue parent skill interest son</span>
</span></code></pre></td></tr></table></div></figure>


<p>  牢记：super() 一定要(),不然会有问题！！！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RUBY魔法师(class_eval和instance_eval)]]></title>
    <link href="http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-class-evalhe-instance-eval/"/>
    <updated>2014-02-23T00:23:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/02/23/rubymo-fa-shi-class-evalhe-instance-eval</id>
    <content type="html"><![CDATA[<p>在RUBY的编程过程中对一个已经创建好的类，或者对象，进行一些运行时的改造，比如增加一个方法，添加一些变量，去除一些方法，或者引入一个module等，是经常会做的事。</p>

<p>  我们先来看看对一个类的动态改造。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span> <span class="o">=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1">#defs here go to Dummy</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say_hi</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;hi&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">say_hi</span> <span class="c1">#—&gt;hi</span>
</span></code></pre></td></tr></table></div></figure>


<p>  当我们定义class的时候，什么实例方法都没有定义。之后，魔法师通过class_eval在运行时，去添加了实例方法say_hi。class_eval do ..end 里的代码，就等于是在 class Dummy ..end里定义的方法。</p>

<p>  再看另一个类子：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1">#defs here go to Dummy’s eigenclass</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say_hello</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;hello&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hello</span> <span class="err">＃—</span><span class="o">&gt;</span><span class="n">hello</span>
</span></code></pre></td></tr></table></div></figure>


<p>魔法师又通过instance_eval在运行时，去添加了类方法say_hello。instance_eval do .. end里的代码，就等于在Dummy的eigenclass里了定义方法。</p>

<p>  魔法师如果不用instance_eval ,在class_eval也可以定义类方法。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">say_bye</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;bye&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_bye</span> <span class="c1">#-&gt;bye</span>
</span></code></pre></td></tr></table></div></figure>


<p>  我们来总结一下class_eval和instance_eval的区别：前者是改变class本身，在do..end里的代码被放入class Dummy …end 中，换成书中的句子就是改变了self. 而后者把所有代码都被放了Dummy.eigenclass里，但没有放在Dummy类中，这样就不会改变Dummy里原来的代码，换成书中的句子就是没有改变Self.</p>

<p>  这两个魔法在RAILS里被无数次的使用。</p>

<p>  对于一个类，实例方法是放在类里的，而类方法是放在这个类的eigenClass里的。
  每个对象，都有自己的EigenClass,其中定义的方法都是这个对象（仅仅这个对象）的实例方法。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>
</span><span class='line'>  <span class="n">obj</span> <span class="o">=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">cry</span>
</span><span class='line'>      <span class="nb">puts</span>  <span class="err">“</span><span class="n">wawa</span><span class="err">”</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">cry</span> <span class="c1">#-&gt;wawa</span>
</span></code></pre></td></tr></table></div></figure>


<p>  而instance_eval魔法正是打开eigenClass的钥匙。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">instace_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">cry</span>
</span><span class='line'>      <span class="nb">puts</span>  <span class="err">“</span><span class="n">wawa</span><span class="err">”</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">cry</span> <span class="c1">#-&gt; wawa</span>
</span></code></pre></td></tr></table></div></figure>


<p>  ！！！发现在一个重大秘密：</p>

<p>  class &lt;&lt; obj/class_name 是打开eigenClass类，obj/class_name.instance_eval也是打开eigenClass类。两者有什么区别?</p>

<p>  答案就是在self上。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span><span class="o">/</span><span class="n">class_name</span>
</span><span class='line'>    <span class="nb">self</span>    <span class="c1">#是指eigenclass</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  而</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">obj</span><span class="o">/</span><span class="n">class_name</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">self</span>  <span class="c1">#是指obj/class_name本身</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  这是最最大的区别！！！切记！！ 了解这一点就能解释清楚以下的手段。</p>

<p>  我们去获取到一个类或者对象的eigenClass,通常采用的方式是：</p>

<p>  一、获取类的eigenclass：
  方式一：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">e</span> <span class="o">=</span> <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="no">Dummy</span>
</span><span class='line'>    <span class="nb">self</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  或者</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">e</span> <span class="o">=</span>  <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>      <span class="nb">self</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  方式二：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">eigenclass</span>
</span><span class='line'>      <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>        <span class="nb">self</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  二、获取对象的eigenclass：</p>

<p>  方式1：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Dummy</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">eigenclass</span>
</span><span class='line'>          <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>              <span class="nb">self</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span> <span class="o">=</span>  <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">eigenclass</span> <span class="err">获取</span><span class="n">obj</span><span class="err">的</span><span class="n">eigenclass</span>
</span></code></pre></td></tr></table></div></figure>


<p>  方式2：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="n">eigenclass</span> <span class="o">=</span> <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span>
</span><span class='line'>      <span class="nb">self</span> <span class="c1">#此处的self代表了obj的eigenclass</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  或者：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">e</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>      <span class="nb">self</span> <span class="c1">#此处的self代表了obj的eigenclass</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  无论哪种方式都比较麻烦。魔法师会用一个特别的方式，直接获取到eigenclass。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">sigleton_class</span>
</span></code></pre></td></tr></table></div></figure>


<p>  再来看一个等式，做为就之前的一个总结，看懂了就说明，理解了。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{}</span>  <span class="o">==</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_class</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>  但是</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span> <span class="nb">self</span> <span class="p">}</span> <span class="o">!=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="nb">self</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>  一、等号说明在｛｝里定义的方法都是Dummy的类方法。
  二、不等号说明在｛｝中的self是有不同含义的。singleton_class.class_eval 中的self是指Dummy的eigenclass,而Dummy.instance_eval是指Dummy类本身</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say_hi</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;hi&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say_hello</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;hello&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hi</span>
</span><span class='line'>  <span class="no">Dummy</span><span class="o">.</span><span class="n">say_hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">instance_methods</span>    <span class="o">[</span><span class="ss">:say_hi</span><span class="p">,</span><span class="ss">:say_hello</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span> <span class="nb">self</span> <span class="p">}</span> <span class="o">==</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="nb">self</span> <span class="p">}</span> <span class="c1">#-&gt;false</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span> <span class="c1">#--&gt; #&lt;Class:Dummy&gt;</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span> <span class="nb">self</span> <span class="p">}</span> <span class="c1">#--&gt; #&lt;Class:Dummy&gt;</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="nb">self</span> <span class="p">}</span> <span class="c1">#--&gt; Dummy</span>
</span></code></pre></td></tr></table></div></figure>


<p>singleton_class在我们对方法的操作上有很多很多的用处，仔细写在RUBY魔法师（方法高级篇）</p>

<p>看看以下例子，再看看我们的重大发现，顿时明白一切。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">obj</span> <span class="o">=</span> <span class="no">Dummy</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">eigenclass_func</span>
</span><span class='line'>      <span class="nb">self</span> <span class="c1">#此处的self代表了obj本身，而不是obj的eigenclass</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  或者</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">eigenclass_func</span>
</span><span class='line'>    <span class="nb">self</span> <span class="c1">#此处的self代表了obj本身，而不是obj的eigenclass</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>  或者</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">e</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">self</span> <span class="c1">#此处的self代表了obj本身，而不是obj的eigenclass</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RUBY魔法师(inject用法)]]></title>
    <link href="http://suzhen.github.com/blog/2014/02/22/rubymo-fa-shi-injectyong-fa/"/>
    <updated>2014-02-22T23:46:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2014/02/22/rubymo-fa-shi-injectyong-fa</id>
    <content type="html"><![CDATA[<p>inject是魔法师常常用到的一种魔法，更具体的说应该是 Enumerable#inject 。我特别特别的钟爱它，它非常的强大，可以让代码看上去很简洁。
  当发现有可能会用到地方，就要尽可能的去施展这种魔法。</p>

<p>  数字求和是最常使用inject的例子，当对一个array of numbers 里的number求和时，就可以施展inject魔法，而不是很土的用array each 的方式去求各。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">inject</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">element</span><span class="o">|</span> <span class="n">result</span> <span class="o">+</span> <span class="n">element</span> <span class="p">}</span> <span class="c1"># =&gt; 10</span>
</span></code></pre></td></tr></table></div></figure>


<p>  inject方法使用一个argument和block, 对于这个array中包含的每一个element,这个block将会执行一次.</p>

<p>  具体步骤如下：</p>

<p>  argument将被传递给block的第一个参数，这个例子中就是block中的result.
  array中第一个element被传递给block的每二个参数，这个例子中就是把1传递给block中的element.
  这个block就变成了 ｛｜0，1｜ 0＋1 ｝
  执行block
  把执行block的结果，即 1，再次传给block的第一个参数。
  array中的第二个element被传递给block的每二个参数，这个例子中就是把2传递给block中的element
  这个block的就变成了 ｛｜1，2｜1＋2 ｝
  执行block
  把执行block的结果，即 3，再次传给block的第一个参数。
  array中的第二个element被传递给block的每二个参数，这个例子中就是把3传递给block中的element
  以此类推。</p>

<p>  这个例子中 block会被执行4次</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="p">{</span><span class="o">|</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">|</span> <span class="mi">0</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span>
</span><span class='line'>     <span class="o">|-----</span><span class="err">⬆️</span>
</span><span class='line'>     <span class="err">⬇️</span>
</span><span class='line'>   <span class="p">{</span><span class="o">|</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">|</span> <span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="p">}</span>
</span><span class='line'>     <span class="o">|-----</span><span class="err">⬆️</span>
</span><span class='line'>     <span class="err">⬇️</span>
</span><span class='line'>   <span class="p">{</span><span class="o">|</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="o">|</span> <span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="p">}</span>
</span><span class='line'>     <span class="o">|-----</span><span class="err">⬆️</span>
</span><span class='line'>     <span class="err">⬇️</span>
</span><span class='line'>   <span class="p">{</span><span class="o">|</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="o">|</span> <span class="mi">6</span><span class="o">+</span><span class="mi">4</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">=&gt;</span><span class="mi">10</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>  魔法其实就是多次执行block, 每次把当前block的返回结果，再作为下一个block的第一个参数传进去，同时传入Enumentable中的下一个element,这样就又组成了一个新的block. array需要each多少次，就会执行多次block. 那么inject最将返回的结果，就是最一次block执行的结果。</p>

<p>  了解inject的原理就可以创造场景的应用了</p>

<p>  建立一个hash</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">hash</span> <span class="o">=</span> <span class="o">[[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="s1">&#39;Shane&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:last_name</span><span class="p">,</span> <span class="s1">&#39;Harvie&#39;</span><span class="o">]].</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">element</span><span class="o">|</span>
</span><span class='line'>      <span class="n">result</span><span class="o">[</span><span class="n">element</span><span class="o">.</span><span class="n">first</span><span class="o">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>     <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># =&gt; {:first_name=&gt;&quot;Shane&quot;, :last_name=&gt;&quot;Harvie&quot;}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>  可以更简单的写：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">hash</span> <span class="o">=</span> <span class="o">[[</span><span class="ss">:first_name</span><span class="p">,</span> <span class="s1">&#39;Shane&#39;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="ss">:last_name</span><span class="p">,</span> <span class="s1">&#39;Harvie&#39;</span><span class="o">]].</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">element</span><span class="o">|</span>
</span><span class='line'>      <span class="n">result</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">to_sym</span> <span class="o">=&gt;</span> <span class="n">element</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">TestResult</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:status</span><span class="p">,</span> <span class="ss">:message</span><span class="p">)</span>
</span><span class='line'>  <span class="n">results</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="no">TestResult</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="s2">&quot;1 expected but was 2&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="no">TestResult</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:sucess</span><span class="p">),</span>
</span><span class='line'>      <span class="no">TestResult</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="s2">&quot;10 expected but was 20&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">grouped_results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">grouped</span><span class="p">,</span> <span class="n">test_result</span><span class="o">|</span>
</span><span class='line'>      <span class="n">grouped</span><span class="o">[</span><span class="n">test_result</span><span class="o">.</span><span class="n">status</span><span class="o">]</span> <span class="o">=</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">grouped</span><span class="o">[</span><span class="n">test_result</span><span class="o">.</span><span class="n">status</span><span class="o">].</span><span class="n">nil?</span>
</span><span class='line'>      <span class="n">grouped</span><span class="o">[</span><span class="n">test_result</span><span class="o">.</span><span class="n">status</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">test_result</span>
</span><span class='line'>     <span class="n">grouped</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">grouped_results</span>
</span><span class='line'>    <span class="c1"># &gt;&gt; {:failed =&gt; [</span>
</span><span class='line'>    <span class="c1"># &gt;&gt;    #&lt;struct TestResult status=:failed, message=&quot;1 expected but was 2&quot;&gt;, </span>
</span><span class='line'>    <span class="c1"># &gt;&gt;    #&lt;struct TestResult status=:failed, message=&quot;10 expected but was 20&quot;&gt;],</span>
</span><span class='line'>    <span class="c1"># &gt;&gt;  :sucess =&gt; [ #&lt;struct TestResult status=:sucess, message=nil&gt; ]</span>
</span><span class='line'>    <span class="c1"># &gt;&gt; }</span>
</span></code></pre></td></tr></table></div></figure>


<p>  建立一个Array</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">array</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="o">].</span><span class="n">inject</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">element</span><span class="o">|</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">element</span><span class="o">.</span><span class="n">to_s</span> <span class="k">if</span> <span class="n">element</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">result</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1"># =&gt; [&quot;2&quot;, &quot;4&quot;, &quot;6&quot;]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">TestResult</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:status</span><span class="p">,</span> <span class="ss">:message</span><span class="p">)</span>
</span><span class='line'>  <span class="n">results</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="no">TestResult</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="s2">&quot;1 expected but was 2&quot;</span><span class="p">),</span>
</span><span class='line'>      <span class="no">TestResult</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:sucess</span><span class="p">),</span>
</span><span class='line'>      <span class="no">TestResult</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:failed</span><span class="p">,</span> <span class="s2">&quot;10 expected but was 20&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">messages</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">messages</span><span class="p">,</span> <span class="n">test_result</span><span class="o">|</span>
</span><span class='line'>     <span class="n">messages</span> <span class="o">&lt;&lt;</span> <span class="n">test_result</span><span class="o">.</span><span class="n">message</span> <span class="k">if</span> <span class="n">test_result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="ss">:failed</span>
</span><span class='line'>       <span class="n">messages</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># =&gt; [&quot;1 expected but was 2&quot;, &quot;10 expected but was 20&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>  inject还可以用在动态给object发消息的</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Recorder</span>
</span><span class='line'>  <span class="nb">instance_methods</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">meth</span><span class="o">|</span>
</span><span class='line'>    <span class="n">undef_method</span> <span class="n">meth</span> <span class="k">unless</span> <span class="n">meth</span> <span class="o">=~</span> <span class="sr">/^(__|inspect|to_str|object_id)/</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="n">messages</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">sym</span><span class="p">,</span> <span class="n">args</span><span class="o">]</span>
</span><span class='line'>    <span class="nb">self</span> <span class="c1">#返回reciver，是为了可以连续发消息。</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">messages</span>
</span><span class='line'>    <span class="vi">@messages</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">play_for</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span class='line'>    <span class="n">messages</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">result</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span>
</span><span class='line'>      <span class="n">result</span><span class="o">.</span><span class="n">send</span> <span class="n">message</span><span class="o">.</span><span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">message</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'> <span class="k">class</span> <span class="nc">Machine</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">will</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;will&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">;</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">record</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="nb">puts</span> <span class="s2">&quot;record&quot;</span><span class="p">;</span><span class="nb">self</span><span class="p">;</span> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">anything</span><span class="p">;</span><span class="nb">puts</span> <span class="s2">&quot;anything&quot;</span><span class="p">;</span><span class="nb">self</span><span class="p">;</span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">you</span><span class="p">;</span><span class="nb">puts</span> <span class="s2">&quot;you&quot;</span><span class="p">;</span><span class="nb">self</span><span class="p">;</span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">want</span><span class="p">;</span><span class="nb">puts</span> <span class="s2">&quot;want&quot;</span><span class="p">;</span><span class="nb">self</span><span class="p">;</span><span class="k">end</span>
</span><span class='line'>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">recorder</span> <span class="o">=</span> <span class="no">Recorder</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">will</span><span class="o">.</span><span class="n">record</span><span class="o">.</span><span class="n">anything</span><span class="o">.</span><span class="n">you</span><span class="o">.</span><span class="n">want</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1"># &gt;&gt; #&lt;Recorder:0x28ed8 @messages=[[:will, []], [:record, []], [:anything, []], [:you, []], [:want, []]]</span>
</span><span class='line'>
</span><span class='line'><span class="n">recorder</span><span class="o">.</span><span class="n">play_for</span><span class="p">(</span><span class="no">Machine</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># will</span>
</span><span class='line'><span class="c1"># record</span>
</span><span class='line'><span class="c1"># anything</span>
</span><span class='line'><span class="c1"># you</span>
</span><span class='line'><span class="c1"># want</span>
</span></code></pre></td></tr></table></div></figure>


<p>施展这个魔法的时候，要注意，def 某个method时，一定要返回reciver本身，才可以连续的调用。</p>

<p>这个例子也是一个DSL的例子，也是一个方法延迟执行的例子。就好像.where().where().where()</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GridFS学习和使用]]></title>
    <link href="http://suzhen.github.com/blog/2013/08/31/gridfsxue-xi-he-shi-yong/"/>
    <updated>2013-08-31T22:59:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2013/08/31/gridfsxue-xi-he-shi-yong</id>
    <content type="html"><![CDATA[<p>GridFS是mongdb的一种存放任意大小文件的功能。把文件存在数据库中的好处是便于检索，备份，以前以后分布式的扩展。而普通document只能保存16MB的文件。</p>

<p>一 基本概念：</p>

<p>  GridFS将文件存入两个collections中。</p>

<p>  <strong>fs.files</strong>
  存放文件相关的数据，比如大小，上传日期，文件类型等</p>

<pre><code>{
  "_id" : &lt;ObjectID&gt;,
  "length" : &lt;num&gt;,
  "chunkSize" : &lt;num&gt;
  "uploadDate" : &lt;timestamp&gt;
  "md5" : &lt;hash&gt;

  "filename" : &lt;string&gt;,
  "contentType" : &lt;string&gt;,
  "aliases" : &lt;string array&gt;,
  "metadata" : &lt;dataObject&gt;,
}
</code></pre>

<p>  <strong>fs.chunks</strong>
  存放文件的字节数据，每个chunks的document的大小是256k。一个大文件会变分割成多个document存放的。</p>

<pre><code>{
  "_id" : &lt;string&gt;, 
  "files_id" : &lt;string&gt;,有索引
  "n" : &lt;num&gt;,有索引
  "data" : &lt;binary&gt;
}
</code></pre>

<p>  一个files的document对应着一或者多个chunks的document。</p>

<p>二 shell操作：</p>

<pre><code>./mongofiles &lt;options&gt; &lt;commands&gt; &lt;filename&gt;

option: -d 指定数据库
    -h GridFS所在主机名。默认是本机，商品27017
    -u 用户名
    -p 密码

command:
      list 文件列表
      search 根据文件名称查找
      put 把文件存入数据库
      get 从数据库中提出文件。注意：如果文件名是带路径的，那必须在当前文件夹下创建该目录结构才可以提出文件。
      delete 删除数据库中文件
</code></pre>

<p>三 rails上传文件到GridFS:</p>

<p>  在rails4.0环境下用到相关gem</p>

<pre><code>gem "mongoid", github: 'mongoid/mongoid', ref: '11e45e5a30a45458b83db99ab6c9d9ccc337e66f'
gem 'mongoid-grid_fs', github: 'ahoward/mongoid-grid_fs'

gem "carrierwave"
gem "carrierwave-mongoid", git: "git://github.com/jnicklas/carrierwave-mongoid.git"
</code></pre>

<p>  首先创建carrierwave的配置文件</p>

<pre><code>touch config/initializers/carrierwave.rb
</code></pre>

<p>  内容如下：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">require</span> <span class="s1">&#39;carrierwave/mongoid&#39;</span>
</span><span class='line'>  <span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="ss">:grid_fs</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;tmp&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="s2">&quot;uploads&quot;</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">grid_fs_access_url</span>   <span class="o">=</span> <span class="s2">&quot;/images&quot;</span>  <span class="c1">#@model.image_url.就是在数据库中的文件名称前，加上的路径(/images+数据库中的文件名称)。</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>  在upload目录下</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">PictureUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>    <span class="c1">#保存在数据库中的文件名</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">store_dir</span>
</span><span class='line'>       <span class="s2">&quot;uploads/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>  这样就可以所文件保存到GridFS中了。</p>

<p>  读取文件：
  1、用脚本读取数据库的数据，在写在页面上。这种方式是比较效率低，只适合在开发环境中使用。</p>

<p>  创建一个GridfsController负责读取GridFS中的文件，并写到页面上去。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">GridfsController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Metal</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">serve</span>
</span><span class='line'>      <span class="n">gridfs_path</span> <span class="o">=</span> <span class="n">env</span><span class="o">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;/images/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">begin</span>
</span><span class='line'>        <span class="n">gridfs_file</span> <span class="o">=</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">GridFS</span><span class="o">[</span><span class="n">gridfs_path</span><span class="o">]</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span> <span class="o">=</span> <span class="n">gridfs_file</span><span class="o">.</span><span class="n">data</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">gridfs_file</span><span class="o">.</span><span class="n">content_type</span>
</span><span class='line'>      <span class="k">rescue</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="ss">:file_not_found</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;text/plain&#39;</span>
</span><span class='line'>        <span class="nb">self</span><span class="o">.</span><span class="n">response_body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p> 所有对文件的访问路径都路由到这个controller中。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="n">get</span> <span class="s2">&quot;/images/uploads/*path&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;gridfs#serve&quot;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>  2、用nginx-gridfs的方法</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关于defined?操作符]]></title>
    <link href="http://suzhen.github.com/blog/2013/08/31/guan-yu-defined-cao-zuo-fu/"/>
    <updated>2013-08-31T17:55:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2013/08/31/guan-yu-defined-cao-zuo-fu</id>
    <content type="html"><![CDATA[<p>defind?是一个和and、not一样的操作符。用来判断表达式是否存在，及是哪种类型的表达式。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">defined?</span> <span class="n">yuchen</span>         <span class="c1">#=&gt; nil</span>
</span><span class='line'><span class="n">defined?</span> <span class="kp">true</span>         <span class="c1">#=&gt; “true”</span>
</span><span class='line'><span class="n">defined?</span> <span class="vg">$*</span>           <span class="c1">#=&gt; &quot;global-variable&quot;</span>
</span><span class='line'><span class="n">defined?</span> <span class="nb">Array</span>        <span class="c1">#=&gt; &quot;constant&quot;</span>
</span><span class='line'><span class="n">defined?</span> <span class="no">Math</span><span class="o">::</span><span class="no">PI</span> <span class="c1">#=&gt; &quot;constant&quot;</span>
</span><span class='line'><span class="n">defined?</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c1">#=&gt; &quot;assignment&quot;</span>
</span><span class='line'><span class="n">defined?</span> <span class="mi">100</span>         <span class="c1">#=&gt; &quot;expression&quot;</span>
</span><span class='line'><span class="n">defined?</span> <span class="mi">100</span><span class="o">.</span><span class="n">times</span>   <span class="c1">#=&gt; &quot;method&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>除此之外还有一些用法：</p>

<p>1、可以来判断是否有block,作用同block_given?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="k">class</span> <span class="nc">Base</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>           <span class="nb">puts</span> <span class="n">defined?</span> <span class="k">yield</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="no">Base</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">foo</span> <span class="p">{}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>执行结果为：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="kp">nil</span>
</span><span class='line'> <span class="k">yield</span> <span class="c1">#如果有block输出&quot;yield&quot;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>2、可以来判断方法里是否有super方法</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Base</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Derived</span> <span class="o">&lt;</span> <span class="no">Base</span>
</span><span class='line'>        <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>           <span class="nb">puts</span> <span class="n">defined?</span> <span class="k">super</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">fun</span>
</span><span class='line'>           <span class="nb">puts</span> <span class="n">defined?</span> <span class="k">super</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">Derived</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">fun</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>执行结果为：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">super</span>
</span><span class='line'> <span class="kp">nil</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>注意一点。如果defined?的参数是一段语句，那是不能被执行的。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">p</span> <span class="n">defined?</span><span class="p">(</span><span class="k">def</span> <span class="nf">x</span><span class="p">;</span> <span class="k">end</span><span class="p">)</span>   <span class="c1"># &quot;expression&quot;</span>
</span><span class='line'><span class="n">x</span>                        <span class="c1"># error: undefined method or variable</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">p</span> <span class="n">defined?</span><span class="p">(</span><span class="vi">@x</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>         <span class="c1"># &quot;assignment&quot;</span>
</span><span class='line'><span class="nb">p</span> <span class="vi">@x</span>                     <span class="c1"># nil</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[点滴知识积累]]></title>
    <link href="http://suzhen.github.com/blog/2012/12/13/ruby-shard/"/>
    <updated>2012-12-13T02:09:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2012/12/13/ruby-shard</id>
    <content type="html"><![CDATA[<p>1) 在程序中经常看见“<strong>__FILE__</strong>”（注意是左边两个下划线，右边两下划线）,这代
表“<strong>__FILE__</strong>”所在文件的文件名。如果“<strong>__FILE__</strong>”是在require或者load的文件中，则是代
表被包含文件的绝对路径和文件名。</p>

<p>a.rb文件:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">p</span> <span class="bp">__FILE__</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>b.rb文件</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">require</span> <span class="s2">&quot;./a&quot;</span>
</span><span class='line'>  <span class="nb">p</span> <span class="bp">__FILE__</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>执行ruby b.rb,输出：</p>

<pre><code>/home/suzhen/workspace/a.rb
b.rb 
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[class和module（基础篇）]]></title>
    <link href="http://suzhen.github.com/blog/2012/12/05/class-module-basic/"/>
    <updated>2012-12-05T00:39:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2012/12/05/class-module-basic</id>
    <content type="html"><![CDATA[<p>   Class与Module是ruby程序大框架的基本构成。掌握好class与module的设计，对ruby程序的层次的清晰和扩展是非常重要的。class名与module名也都是常量。和我们定义的常量在某种意义上说没有区别。第一个字母都必须是大写。Class类是Module的子类，class是一特殊形式的模块。我们应该牢记最顶级的类是Object,最顶级的模块就是Kernel。我们从最简单的开始了解和熟悉他们的用法与设计。</p>

<p>   一、module的创建与mixin</p>

<p>   例子一：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="c1">#创建module</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Mymodule</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2"> say: hello&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="c1">#不仅能定义实例方法，还能定义常量，实例对象，类对象，宏，甚至是initialize方法。</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Myothermodule</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">cry</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="si">}</span><span class="s2"> cry: wawawa~&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#在类中引用module</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Myfirstclass</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Mymodule</span> <span class="c1">#include说明module里的方法是被当作实例方法被引用的,方法里的self代表对象</span>
</span><span class='line'>    <span class="kp">extend</span> <span class="no">Myothermodule</span> <span class="c1">#extend说明module里的方法是被当作类方法被引用的，方法里的self代表类</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#无论哪种引用，都要把module里的代码从头到底执行一遍，和定义类一样。</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">fobj</span><span class="o">=</span><span class="no">Myfirstclass</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">fobj</span><span class="o">.</span><span class="n">say</span> <span class="c1">#Myfirstclass say : hello</span>
</span><span class='line'>  <span class="no">Myfirstclass</span><span class="o">.</span><span class="n">cry</span> <span class="c1">#Myothermodule say: wawawa~</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>可以用类的included_modules方法查看该类包含了多少个module，当然不包括extend的。</p>

<pre><code>Myclass.included_modules 
</code></pre>

<p>例子二：
我们还可以先不用在类里面混入模块，而是在类的实例里混入模块，可以达到同样的效果。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">module</span> <span class="nn">Mymodule</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>       <span class="nb">puts</span> <span class="s2">&quot;hello&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Myclass</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>*用实例对象extend模块就是实例方法</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">obj</span> <span class="o">=</span> <span class="no">Myclass</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Mymodule</span><span class="p">)</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">say</span> <span class="c1">#hello</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>*用动态派发的方式也可以mixin一个模块</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">Myclass</span><span class="o">.</span><span class="n">send</span> <span class="ss">:include</span><span class="p">,</span><span class="no">Mymodule</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>*用类extend模块就是类方法</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">Myclass</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Mymodule</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Myclass</span><span class="o">.</span><span class="n">say</span> <span class="c1">#hello</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>   以上的写法更多的是用在module的callback中</p>

<p>说明：module的作用之一是把若干类中，共有的逻辑部分提出来，起到“一处定义修改，所有引入”均可以改动的意义，目的是为了更好的组织类方法和实例方法。
我们可以把两个module放在别外一个文件内module.rb，在class文件里只要需要引用(require &#8220;路径/module&#8221;)就可以使用。
重构代码的一步。mixin从技术层次理解，就是ruby自动创建了一个module名的代理类，并且让Myfirstclass类继承了这个代理类。实现一个类可以继承多个类的效果。
比如fobj或者sobj寻找方法，会先从自身类去找，如果找不到就从自身类的代理类去找，还找不到再从父类去找，如果还找不到，就去父类的代理找，一直向上。如果在某一处找到了，就停止寻找了。
还有一点要注意的是同名方法的查找,后面模块的引用方法覆盖前面模块的引用方法的. 如下例子</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">module</span> <span class="nn">Pmodule</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>       <span class="nb">puts</span> <span class="s2">&quot;proxy say: hello&quot;</span>
</span><span class='line'>             <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Fclass</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;father say:hello&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Sclass</span><span class="o">&lt;</span><span class="no">Fclass</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Pmodule</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>     <span class="nb">puts</span> <span class="s2">&quot;son say:hello&quot;</span>
</span><span class='line'>     <span class="k">super</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">=</span><span class="no">Sclass</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">say</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="s2">&quot;son say:hello&quot;</span>
</span><span class='line'>  <span class="s2">&quot;proxy say:hello&quot;</span>    <span class="c1">#super指向了module的方法say，而不是父类的say</span>
</span><span class='line'>  <span class="s2">&quot;father say:hello&quot;</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>   二、module与class的区别和理解</p>

<p>   1、module是不能实例对象的，也就是module不能拥有自己的实例变量。在module里的实例变量只能被混入的类的使用。但是常量可以直接使用。</p>

<pre><code> module Mymodule
   PI=3.14
 end
 class Myclass
   PI=3.14
 end

 Mymodule::PI #3.14
 Myclass::PI  #3.14
</code></pre>

<p>   2、module中的定义方法如果不是module的单例方法，只能混入类的被类或者类的对象执行。但如果是module的单例方法，那么可以直接执行，但不能被混入类中无论是(include,还是extend)。</p>

<pre><code> module Mymodule
    def self.say
        puts "#{self} say: hello"
    end
    def cry
        puts "wawawa~"
    end
 end   
 Mymodule.say  #Mymodule say:hello
 Mymodule.cry   #error
</code></pre>

<p>我们可以把这个module使用一个更显得专业的写法</p>

<pre><code> module Mymodule
   class&lt;&lt;self
      def say
          puts "#{self} say: hello"
      end
   end
 end   
 Mymodule.say  #Mymodule say:hello
</code></pre>

<p>既然单例方法可以直接使用，那么如果我们写一个宏的话，那么也可以直接引用变量了。</p>

<p>另一个例子：</p>

<pre><code> module Mymodule
  class&lt;&lt;self
    attr_accessor :name
    def say
        self.name="suzhen"
        puts "#{self.name} say: hello"
    end
  end
 end
 Mymodule.say  # suzhen.name say: hello
 puts Mymodule.name #suzhen
</code></pre>

<p>说明：name将成为Mymodule的一个变量一样可以使用了。非常的cool，感谢有ruby的单例方法。
<strong>切记如果是module的单例方法混入是类里是没有用的。</strong></p>

<p>三，module与class的嵌套
   module里面可以嵌套若干个module，也可以嵌套若干个classs,class里面可以嵌套若干个class,也可以嵌套若干个module</p>

<pre><code>module Mymodule
  module Myothermodule
    PI=3.14
  end
end

puts Mymodule::Myothermodule::PI
</code></pre>

<p>输出：#3.14</p>

<pre><code>class Myclass
  module Mymodule
    PI=3.14
    def self.say(who)
      Inclass.new.say(who)
    end
  end
  class Inclass
    def say(who)
     puts "#{who},hello,world"
    end
  end
  def sound
    Inclass.new.say(self.class::Mymodule::PI)
  end
end
puts Myclass::Mymodule::PI  #3.14
puts Myclass::Mymodule.say("suzhen")  #suzhen,hello world
puts Myclass.new.sound #3.14,hello world
</code></pre>

<p>   现在讨论一下嵌套的意义：
   module嵌套class的意义就像namespace一样，可以把一部分相关的类逻辑上分开。
   class里嵌套module也是同样的作用。我们在元编程中会，会打开一个类，把自己的逻辑写进去，这样我们就需要用一个module来把自己的逻辑隔开。好比一个独立的逻辑空间，该moduel通过class&lt;&lt;self&#8230;end使自身也带有方法，属性等。</p>

<p>   这里有两个非常有用的方法：一个是来判断一个类或者模块里是否嵌套着别一个类或者模块。二个是来获取这个名称的类或者模块。</p>

<pre><code>Mymodule.const_defined?("Myothermodule") 
Mymodule.const_get("ClassMethods").class #Module
</code></pre>

<p>   通常会这种用：</p>

<pre><code>base.extend const_get("ClassMethods") if const_defined?("ClassMethods")
</code></pre>

<p>   四、module的callback方法
   module被include后会有一个callback的方法，我们可以重写这个方法来完成一些事。</p>

<p>   例子一：</p>

<pre><code>   module Mymodule
     def self.included(cls)
    puts "minix in #{cls}"
     end
   end

   class Myclass
      include Mymodule
   end

   输出：
   minix in Myclass
</code></pre>

<p>   如果是这个module被extend则不会callback这个方法</p>

<p>   说明：这个callback有一个非常有用的技巧可以用到。可以解决怎么在一个module中即有实例方法，又有类方法，而在混入类中只需要include就可以了。</p>

<p>   例子二：</p>

<pre><code>   module Base
       #实例方法
       def show  
      puts "You came here!"  
       end  

       #扩展类方法  
       def self.included(base)  
      #额外创建几个类方法
      def base.say  
        puts "I'm strong!"  
      end  
      #混入类方法
      base.extend(ClassMethods)  
       end  

       #类方法  
       module ClassMethods  
     def hello  
       puts "Hello baby!"  
     end  
       end  
   end  

  class Bus  
    include Base  
   end 

  Bus.new.show
  Bus.say  
  Bus.hello 
</code></pre>

<p>   五、module依赖另一个module的方式和问题</p>

<p>例子一：</p>

<pre><code>module Mymodule
  def say
    puts "#{self.name} say: hello" #这个self还是类或者类对象
  end
end

module Myren
  include Mymodule
end

class Myclass
  include Myren
  def name
    name="suzhen"
    name
  end
end

a = Myclass.new
a.say  #suzhen say:hello
</code></pre>

<p>   会出现的问题在是callback上</p>

<pre><code>   module Mymodule
     def self.included(base)
       puts base  #Myren 而不是Myclass
     end
   end

   module Myren
     include Mymodule
     def self.included(base)
       puts base #这里才是Myclass
     end
   end

   class Myclass
     include Myren
   end

   a = Myclass.new
</code></pre>

<p>   问题：如果我想在Mymodule的included中做一些针对混入类的操作，就变的不可能了，因为此时的base是中间的那个module了，而不是混入类了。解决这个问题的笨方法就是</p>

<p>   Myren中去掉include Mymodule,类Myclass中引入两个module</p>

<pre><code>class Myclass
  include Myren,Mymodule
end  
</code></pre>

<p>   但这么做会有一个问题就是。有时候我们只想引用一个Myren，那就没办法了。那么怎么解决这个问题？Rails里有一个模块可以帮我们解决这个问题。</p>

<p>   例子二：</p>

<pre><code>require 'rubygems'
require 'active_support/concern'
module Mymodule
   extend ActiveSupport::Concern
   included do  
     puts self  #Myclass
   end
end

module Myren
  extend ActiveSupport::Concern
  include Mymodule
  included do
    puts self  #Myclass
  end
end

class Myclass
  include Myren
end

a = Myclass.new
</code></pre>

<p>   首先引入active_support/concern文件，在两个module中分别加入extend ActiveSupport::Concern，这样两个模块就不要再用自己的callback函数了。而是改成 included do &#8230; end
   这个模块中的self就是混入类本身了。神奇的是不光为你做了这些，还省了你在一个module中定义实例方法和类方法的技巧。只需要把类方法放在一个名叫：ClassMethods的module里即可，非常的方便。</p>

<p>   例子三：</p>

<pre><code>require 'rubygems'
require 'active_support/concern'
module Mymodule
  extend ActiveSupport::Concern
  module ClassMethods
    def say
      puts "hello"
    end
  end

  module InstanceMethods #也可不放把实例方法放在这个module里。
    def cry
     puts "wawawa~"    
    end
  end
end

class Myclass
  include Mymodule
end

Myclass.say #hello
Myclass.new.cry #wawawa
</code></pre>

<p>  在ruby的世界中说是针对类进行逻辑结构的搭建，不如说是针对模块的逻辑结构搭建。大量的逻辑会写在module中，而不是直接写在类的，因为那样的重用性会很差。
  良好的程序结构就是有不同的module和class在不同的层次上发挥着作用。比如：如果我们打一个别人的类，那想写点类方法，其实是很危险的，很容易就出现猴子补丁的情况。
  那么干脆新建一个module,然后让那些类方法，成为module的单例方法，就可以类似类方法的调用了。Redis::search::query()</p>

<p>  六、class也有一个callback方法，就是继承后self.inherited方法,如果class被继承就会callback这个方法，如果class的子类再被继承同样也会callback该class这个方法。</p>

<pre><code>class Myclass
  def self.inherited(subclass)
    p subclass
  end
end

class Mysubclass&lt;Myclass
end

class Mygrandsonclass&lt;Mysubclass
end
</code></pre>

<p>输出：</p>

<pre><code>Mysubclass
Mygrandsonclass
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ruby中的变量]]></title>
    <link href="http://suzhen.github.com/blog/2012/12/03/rubyvar/"/>
    <updated>2012-12-03T02:45:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2012/12/03/rubyvar</id>
    <content type="html"><![CDATA[<p>ruby上的变量分为局部变量(local variables)，全局变量(global variables)，类的实例变量(class instance variables)，对象的实例变量(object instance variables)和类变量(class variables)。每个变量的
作用，特性和作用域都有所不同。首先要对这些变量有充分深刻的认识,细细抠它们之间的区别
，才能在以后的应用中准确的使用。</p>

<p>1、定义变量</p>

<p> 局部变量直接以小写字母，或者下划线开始，如：</p>

<pre><code>tmp=[]
_tmp=true
</code></pre>

<p> 以$开头的变量是全局变量,如：</p>

<pre><code>$config= {:site=&gt;"bizmass.com"}
</code></pre>

<p> 类的实例变量和对象的实例变量，即实例变量用@开头，如：</p>

<pre><code>@name="suzhen"
</code></pre>

<p> 类变量用@@开头，如：</p>

<pre><code>@@count=1
</code></pre>

<p>2、变量的区别和用法</p>

<p>1）局部变量会存在的范围：
 proc{&#8230;} <br/>
 lambda do..end
 def&#8230;end <br/>
 class&#8230;end <br/>
 module&#8230;end<br/>
 局部变量属于所在的作用域，它的生命起始于声明处，结束于该声明所在的块、方法定义、类
、模块定义的结尾。随着作用域的结束，局部变量的生命也将结束。如果局部变量在生命期内，
变包含在一个闭包中，它的生命会因为这个闭包在作用域结束的时间得到延续。</p>

<p>2）全局变量会在程序的任何一个地方定义，在不同的类/模块/所在的范围里都可以读取和改变
。全局变量是唯一的。
   注意：应谨慎使用全局变量.由于在任何地方都可以被写因此他们相当危险.滥用全局变量会
导致很难隔离臭虫;同时也视为程序的设计未经严格考虑.当你发现必须要使用全局变量时,记得
给它一个不会在其它地方一不小心就用到的描述性名字，避免在其它地方变无意修改。</p>

<pre><code>global_variables #查看所有全局变量
</code></pre>

<p>  全局变量的改变是可以被跟踪的。如果它的值被改变，就会执行一个proc。像是一个触发器。</p>

<pre><code>trace_var :$x,proc{ p "$x is now #{$x}"  }

ruby&gt; $x = 5 

$x is now 5 
</code></pre>

<p>3）类变量要声明在类定义中，类变量是<strong>类</strong>、<strong>子类</strong>，<strong>类的实例对象</strong>，<strong>子类实例对象</strong>中共
享的一个变量，即该类整个家族中在类方法中，又可以在实例方法中共享该变量。访类族对类变
量影响是共同承担的。
<strong>但是子类中定义的类变量，在父量中是不以被访问到的,类变量是向下共享的.</strong></p>

<p>类变量的作用域就在声明所在类族和类的对象中。不同类族内有相关名字的类变量，但这是不同
的类变量，只是名称一样罢了,彼此不影响.</p>

<p><strong>注意：要先定义，直接使用异常，在定义一个类变量时，必须要马上赋值。</strong></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">Mysuperclass</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">say</span>
</span><span class='line'>      <span class="vc">@@a</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Myclass</span><span class="o">&lt;</span><span class="no">Mysuperclass</span>
</span><span class='line'>    <span class="vc">@@a</span><span class="o">=</span><span class="s2">&quot;suzhen&quot;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">say</span>
</span><span class='line'>      <span class="vc">@@a</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Mysubclass</span><span class="o">&lt;</span><span class="no">Myclass</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">play</span>
</span><span class='line'>     <span class="vc">@@a</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Myclass</span><span class="o">.</span><span class="n">say</span> <span class="c1">#suzhen</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Mysubclass</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">play</span> <span class="c1">#suzhen</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Mysuperclass</span><span class="o">.</span><span class="n">say</span> <span class="c1">#报没有申明类变量的错误</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>这和全局变量不一样。类变量是私有的，在类外无法直接访问，你只能通过实例方法和类方法去
访问它。</p>

<p>模块中定义的类变量(模块变量)被所有包含该模块的类所共享。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">module</span> <span class="nn">TestModule</span>
</span><span class='line'>    <span class="vc">@@foo</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Klass</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Foo</span>
</span><span class='line'>    <span class="nb">p</span> <span class="vc">@@foo</span> <span class="o">+=</span> <span class="mi">1</span>          <span class="c1"># =&gt; 11</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Base</span>
</span><span class='line'>    <span class="kp">include</span> <span class="no">Foo</span>
</span><span class='line'>    <span class="nb">p</span> <span class="vc">@@foo</span> <span class="o">+=</span> <span class="mi">2</span>          <span class="c1"># =&gt; 12</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>但是类变量有一个问题就是在类外面，也是随时可以改变这个变量值的。这是一个危险。
另一个例子：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">Myclass</span>
</span><span class='line'>    <span class="vc">@@koko</span><span class="o">=</span><span class="mi">23</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">pkoko</span>
</span><span class='line'>      <span class="vc">@@koko</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="vc">@@koko</span><span class="o">=</span><span class="mi">99</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Myclass</span><span class="o">.</span><span class="n">pkoko</span> <span class="c1">#99</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>同名类变量在类外面是可以一下改变的，比如：在所有类外面@@koko=100,那么所有类族中的同
名类变量@@koko都会改变。</p>

<p>4）类的实例对象，是类作为对象，所产生的实例对象。深刻理解一切都是对象这句话,就需要把
类当作一个普通对象去看待。类的实例对象是用来记录只属于该类的一些属性。比如想记录一下
某个类被实例化了多少次，或者被哪些继承了。我们都可以创建一个类的实例对象来记录这些。
这就是类的实例对象的用途。
  在类定义中去声明类的实例变量，而这些类的实例变量只能在类方法中使用。即然类实例变量
是针对某一个类的，那自然就不可能被子类使用，失去了被继承的价值和意义。因此如果要定义
需要和子类共享的类全局数据，使用类变量；但是如果要定义仅供类本身使用的类全局数据可以
使用类实例变量。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">Myclass</span>
</span><span class='line'>            <span class="vi">@age</span><span class="o">=</span><span class="mi">12</span> <span class="c1">#类实例变量</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>          <span class="nb">p</span> <span class="vi">@age</span> <span class="c1">#nil 错误，类的实例变量不能放在实例方法中,会被误认为是对象的实例变量</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">cry</span>
</span><span class='line'>          <span class="nb">p</span> <span class="vi">@age</span> <span class="c1">#12 类的实例变量只能在类方法中使用</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Mysonclass</span> <span class="o">&lt;</span> <span class="no">Myclass</span>
</span><span class='line'>     <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">meet</span>
</span><span class='line'>       <span class="nb">p</span> <span class="vi">@age</span> <span class="c1">#nil 错误，父类的类实例变量不能被继承的，会被误认为是当前类的类实例变量</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>定义类的实例变量还可以有几种方式：</p>

<p>方式一：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">Myclass</span>
</span><span class='line'>     <span class="n">class</span><span class="o">&lt;&lt;</span><span class="nb">self</span>
</span><span class='line'>      <span class="kp">attr_accessor</span> <span class="ss">:age</span> <span class="c1">#类的实例变量</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="no">Myclass</span><span class="o">.</span><span class="n">age</span><span class="o">=</span><span class="mi">2</span>
</span><span class='line'>  <span class="nb">p</span> <span class="no">Myclass</span><span class="o">.</span><span class="n">age</span> <span class="c1">#2</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>方式二：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">Myclass</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:age</span> <span class="c1">#类的实例变量</span>
</span><span class='line'>    <span class="c1">#顺便说一句，要搞清楚现在是在一个类的环境中</span>
</span><span class='line'>    <span class="nb">self</span> <span class="c1">#代表这个类</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>5）再思考一下对象实例变量，对象实例变量会保存对象中，而实例方法会保存在类中。</p>

<p>它们只能在类的实例方法中被使用，也可以被继承。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">class</span> <span class="nc">Myclass</span>
</span><span class='line'>     <span class="kp">attr_accessor</span> <span class="ss">:name</span>
</span><span class='line'>     <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>         <span class="vi">@name</span><span class="o">=</span><span class="s2">&quot;suzhen&quot;</span> <span class="c1">#对象实例变量</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>     <span class="k">def</span> <span class="nf">say</span>
</span><span class='line'>        <span class="nb">p</span> <span class="vi">@name</span> <span class="c1">#suzhen</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>     <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">cry</span>
</span><span class='line'>        <span class="nb">p</span> <span class="vi">@name</span> <span class="c1">#nil 错误，对象实例变量不能放在类方法中，会被识认为是类的实例变量</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Mysonclass</span> <span class="o">&lt;</span> <span class="no">Myclass</span>
</span><span class='line'>     <span class="k">def</span> <span class="nf">talk</span>
</span><span class='line'>       <span class="nb">p</span> <span class="vi">@name</span> <span class="c1">#suzhen 父类的对象实例变量是可以被继承的</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们不在定义类的时候定义好这些实例变量，也可以在之后的编程过程中去创建这些实例变
量。在对象里加的实例变量就是对象实例变量，在类里加的实例变量就是类的实例变量。</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">Myclass</span><span class="o">.</span><span class="n">instance_variable_defined?</span><span class="p">(</span><span class="s2">&quot;@age&quot;</span><span class="p">)</span>   <span class="c1">#true</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">instance_variable_defined?</span><span class="p">(</span><span class="s2">&quot;@name&quot;</span><span class="p">)</span>   <span class="c1">#true</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Myclass</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@age&quot;</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Myclass</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@age&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@name&quot;</span><span class="p">,</span> <span class="s2">&quot;even&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">obj</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@name&quot;</span><span class="p">)</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>其实Myclass.instance_eval也可以实现，但我不喜欢这种方式，会容易搞混。</p>

<p>问题：
类变量和类实例变量有什么区别？
http://snippets.aktagon.com/snippets/299-class-variables-vs-class-instance-variables-in-ruby
http://www.railstips.org/blog/archives/2006/11/18/class-and-instance-variables-in-ruby/</p>

<p>6)宏
attr_accessor,attr_reader,attr_writer都是创建实例变量(类实例变量,对象实例变量)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Myclass</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:age</span>  <span class="c1">#创建对象实例变量                                                                                                                                      </span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">Myclass</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">age</span><span class="o">=</span><span class="mi">1</span>
</span><span class='line'><span class="nb">p</span> <span class="n">obj</span><span class="o">.</span><span class="n">age</span> <span class="c1">#1                                                                                                                                                                 </span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="n">class</span><span class="o">&lt;&lt;</span><span class="nb">self</span><span class="p">;</span> <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">;</span><span class="k">end</span> <span class="p">}</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span><span class="mi">1</span>
</span><span class='line'><span class="nb">p</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="c1">#1</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Myclass</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:count</span>  <span class="c1">#创建类实例变量</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Myclass</span><span class="o">.</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span>
</span><span class='line'><span class="nb">p</span> <span class="no">Myclass</span><span class="o">.</span><span class="n">count</span>  <span class="c1">#1</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Myclass</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span>  <span class="n">class</span><span class="o">&lt;&lt;</span><span class="nb">self</span><span class="p">;</span> <span class="kp">attr_accessor</span> <span class="ss">:sum</span><span class="p">;</span><span class="k">end</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="no">Myclass</span><span class="o">.</span><span class="n">sum</span><span class="o">=</span><span class="mi">1</span>
</span><span class='line'><span class="nb">p</span> <span class="no">Myclass</span><span class="o">.</span><span class="n">sum</span>  <span class="c1">#1</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[require/load/autoload的区别和用法]]></title>
    <link href="http://suzhen.github.com/blog/2012/12/03/importfile/"/>
    <updated>2012-12-03T01:34:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2012/12/03/importfile</id>
    <content type="html"><![CDATA[<p>首先我们建两个目录，一个命名rubylib，目录下有一个lib.rb文件，另一个目录命名rubyconfig,目录下有一个cfg.rb文件。</p>

<p>lib.rb</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">puts</span> <span class="s2">&quot;I&#39;m lib&quot;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>cfg.rb</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">puts</span> <span class="s2">&quot;I&#39;m config&quot;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>再建立一个testrequire.rb文件</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">require</span> <span class="s2">&quot;./rubylib/lib&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;hello,world&quot;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s2">&quot;./rubylib/lib&quot;</span> <span class="c1">#遇到相同的文件，不再加载</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>输出结果</p>

<pre><code>I'm lib
hello,world
</code></pre>

<p>再建立一个testload.rb文件</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">load</span> <span class="s2">&quot;./rubyconfig/cfg.rb&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;hello,world&quot;</span>
</span><span class='line'>  <span class="nb">load</span> <span class="s2">&quot;./rubyconfig/cfg.rb&quot;</span> <span class="c1">#无论是否加载过，都会加载</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>输出结果</p>

<pre><code>I'm config
hello,world
I'm config
</code></pre>

<p>说明：require和load同样都是用来加载文件。require的加载路径可以不写.rb,但是load就一定要写全文件名。require是只加载一次，如果有相同的文件，已经加载，则不再重复加载，用于加载库文件;而load是每次都会加载，无论是否已经加载过，常用于加载配置文件。
<strong>require和load都表现为立即加载文件。而autoload则是使用到某个类时，才会去加载必要的文件。</strong></p>

<p>建立一个mylib.rb的文件</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">puts</span> <span class="s2">&quot;I was loaded!&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">class</span> <span class="nc">MyLibrary</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>使用require加载会立即加载</p>

<pre><code>irb(main):001:0&gt; require 'mylibrary'
I was loaded!
=&gt; true
</code></pre>

<p>使用autoload只会在这个类被需要的时候，才去加载</p>

<pre><code>irb(main):001:0&gt; autoload :MyLibrary, 'mylibrary'
=&gt; nil
irb(main):002:0&gt; MyLibrary.new
I was loaded!
=&gt; #&lt;MyLibrary:0x0b1jef&gt;
</code></pre>

<p>autoload不会被重复加载!</p>

<p>如果有一些类或者模块一定会被用上，则使用require，如果不一定会被使用，才使用autoload。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[octopress学习笔记]]></title>
    <link href="http://suzhen.github.com/blog/2012/12/03/octopressxue-xi-bi-ji/"/>
    <updated>2012-12-03T01:14:00+08:00</updated>
    <id>http://suzhen.github.com/blog/2012/12/03/octopressxue-xi-bi-ji</id>
    <content type="html"><![CDATA[<p>octopress学习笔记(一)</p>

<p>一些常用的命令和知识点</p>

<p>克隆octopress.git到本地</p>

<pre><code>git clone git://github.com/imathis/octopress.git octopress
</code></pre>

<p>进入octopress项目</p>

<pre><code>cd octopress
</code></pre>

<p>此时需要我们来确定是否将ruby的版本切换到rvm中的1.9.3，输入&#8221;y&#8221;,确定。</p>

<pre><code>bundler install
</code></pre>

<p>octopress的大部分操作都是会通过本身的rake任务来完成的。
可以通过查看Rakefile里的内容来查看，可以通过rake list来查看一些rake命令。</p>

<p>octopress会把blog的主题放在一个.themes的目录下。
我们的第一步就是要加载这个主题</p>

<pre><code>rake install 
</code></pre>

<p>默认加载的主题是classic,加载的过程是把.themes的内容分别拷贝到./source和./sass两个目
录里。sass里放的这个theme是css,而source里放的是theme的html文件和脚本、图片等。</p>

<p>此时我们就可以预览一下这个新blog了。</p>

<pre><code>rake preview 
</code></pre>

<p>这个命令会在目录下出现在一个public的子目录，里面就是程序生成的静态页面。
在浏览器里输入0.0.0.0:4000，就可以看到样子了。是不是很简单。</p>

<p>但是页面里显示得都是些原始的信息，需要我们去设置成自己的信息。就在目录下有一个
_config.yml中可以配置。这个文件里有三部分，一是基本配置，配置
url,title,subtitle,author等，二是配置Jekyll,这部分是设置一些静态文件的目录，路由规则
等。第三部分是一些第三方的功能的设置，比如twitter,googleplus,disqus等。配置好了这些
，再重新rake preview 一下就可以看到包含自己信息的blog了。</p>

<p>我们开始写博客，也是用rake来创建。</p>

<pre><code>rake new_post[博客标题]
</code></pre>

<p>这时候会在source目录下的_post目录下产生一个年月日和文章名称组成的<strong><strong>-</strong>-</strong>-
**.markdown文件，我们编辑这个文件就行了。如果想删除这篇博客文章，通过删除这个文件就
可以了。</p>

<p>编辑好了文章，就需要将文章转化成相应的静态文件，放在public目录下了，这样才能访问到。</p>

<pre><code>rake generate
</code></pre>

<p>我们刷新一下0.0.0.0:4000就可以看到新文章了。</p>

<p>最后是我们要将博客发布到github上。就需要设置一下github的地址。</p>

<pre><code>rake setup_github_pages
</code></pre>

<p>此时，输入***.github.com之后，会在目录下创建一个<em>deploy的目录，并且初始化为一个git仓
库。
当我们已经把markdown转化为public目录下的静态文件后，就可以通过deploy命令把public下的
内容放到</em>deploy目录下，加入版本库，并上传到关联的github的master分支上。</p>

<pre><code>rake deploy
</code></pre>

<p>一个命令所有事搞定。</p>

<p>我们对博客的修改其实是对source和sass的修改，那么修改后的内容也应该用git管理起来，只
需要</p>

<pre><code>git add .
git commit -m "修改内容"
</code></pre>

<p>就可以进行博客的管理。在.gitignore中系统已经自动的把_deploy和public这目录排除了。当
然这个也是需要推送到github上source分支的。</p>

<pre><code>git push origin source
</code></pre>

<p>如果我们需要在另一台机器上也可以写博客，那么就需要把***.github.com仓库克隆到本地。</p>

<pre><code>    git clone git@github.com:suzhen/suzhen.github.com.git octopress
</code></pre>

<p>查看一下分支</p>

<pre><code>    git branch
</code></pre>

<p>会发现有master和source两个分支，通过git checkout source 切换到代码分支就可以开发博客
了。但是我们会发现<em>deploy这个文件并不存在。rake deploy命令并不能执行。所以我们还需要
将deploy从github上克隆下来。在octopress目录里再git clone
git@github.com:suzhen/suzhen.github.com.git </em>deploy 就可以了。这样我们就可以继续使用
rake deploy命令了。</p>
]]></content>
  </entry>
  
</feed>
